# syntax=docker/dockerfile:1.7
# Where: services/agent/Dockerfile.containerd
# What: Agent image for containerd runtime with CNI tooling.
# Why: Provide containerd + CNI dependencies explicitly for runtime parity.

ARG OS_BASE_IMAGE

# Builder Stage
FROM golang:1.25.1-bookworm@sha256:c423747fbd96fd8f0b1102d947f51f9b266060217478e5f9bf86f145969562ee AS builder

WORKDIR /app

# Copy the meta package first (from additional context)
COPY --from=meta . /meta/

# Copy go.mod and go.sum (local to context=services/agent)
COPY go.mod go.sum ./

# Update replace directive to point to /meta in container
RUN sed -i 's|../../meta|/meta|g' go.mod

RUN go mod download

# Copy the entire agent service source code
COPY . .

# Build the binary
RUN CGO_ENABLED=0 GOOS=linux go build -o /app/agent ./cmd/agent

# Runtime Stage
FROM ${OS_BASE_IMAGE} AS runtime

ARG ESB_VERSION
ARG GIT_SHA
ARG BUILD_DATE
ARG IMAGE_RUNTIME
ARG COMPONENT

RUN set -eu; \
    if [ -z "$ESB_VERSION" ]; then echo "ERROR: ESB_VERSION is required" >&2; exit 1; fi; \
    if [ -z "$GIT_SHA" ]; then echo "ERROR: GIT_SHA is required" >&2; exit 1; fi; \
    if [ -z "$BUILD_DATE" ]; then echo "ERROR: BUILD_DATE is required" >&2; exit 1; fi; \
    if [ -z "$IMAGE_RUNTIME" ]; then echo "ERROR: IMAGE_RUNTIME is required" >&2; exit 1; fi; \
    if [ -z "$COMPONENT" ]; then echo "ERROR: COMPONENT is required" >&2; exit 1; fi

ENV ESB_VERSION="${ESB_VERSION}"
ENV IMAGE_RUNTIME="${IMAGE_RUNTIME}"
ENV COMPONENT="${COMPONENT}"

WORKDIR /app

# Install containerd runtime tools and CNI plugins (apt-get as base is Debian)
RUN apt-get update && apt-get install -y --no-install-recommends \
    iproute2 \
    iptables \
    curl \
    && CNI_PLUGINS_VERSION="v1.3.0" \
    && ARCH=$(uname -m) \
    && if [ "$ARCH" = "x86_64" ]; then ARCH="amd64"; fi \
    && if [ "$ARCH" = "aarch64" ]; then ARCH="arm64"; fi \
    && curl --fail --location --retry 5 --retry-delay 2 --retry-all-errors --connect-timeout 15 --max-time 300 \
    -o cni-plugins.tgz "https://github.com/containernetworking/plugins/releases/download/${CNI_PLUGINS_VERSION}/cni-plugins-linux-${ARCH}-${CNI_PLUGINS_VERSION}.tgz" \
    && mkdir -p /opt/cni/bin \
    && tar -C /opt/cni/bin -xzf cni-plugins.tgz \
    && rm cni-plugins.tgz \
    && apt-get purge -y --auto-remove curl \
    && rm -rf /var/lib/apt/lists/*

# CNI configuration will be generated dynamically by the agent on startup.

COPY --from=builder /app/agent /app/agent

# entrypoint.sh (local)
COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

ENV PORT=50051

EXPOSE ${PORT}

ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["/app/agent"]
