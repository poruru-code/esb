# Where: config/haproxy.gateway.cfg
# What: HAProxy TCP forwarding for registry access over WireGuard.
# Why: Expose the control-plane registry via the gateway WG IP without a new container.

global
  log stdout format raw local0
  maxconn 1024

defaults
  mode tcp
  log global
  timeout connect 5s
  timeout client  30s
  timeout server  30s

resolvers docker
  nameserver dns 127.0.0.11:53
  resolve_retries 3
  timeout resolve 1s
  timeout retry 1s
  hold valid 10s

frontend registry_in
  bind 0.0.0.0:5010
  default_backend registry_backend

frontend s3_in
  bind 0.0.0.0:9000
  default_backend s3_backend

frontend db_in
  bind 0.0.0.0:8000
  default_backend db_backend

frontend logs_in
  bind 0.0.0.0:9428
  default_backend logs_backend

backend registry_backend
  server registry registry:5010 check resolvers docker init-addr none

backend s3_backend
  server s3 s3-storage:9000 check resolvers docker init-addr none

backend db_backend
  server db database:8000 check resolvers docker init-addr none

backend logs_backend
  server logs victorialogs:9428 check resolvers docker init-addr none
