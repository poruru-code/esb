# Where: tools/dind-bundler/Dockerfile
# What: DinD bundle image definition.
# Why: Run ESB stack with preloaded images in a single container.

FROM docker:24-dind

ARG BRAND_HOME=.esb
ARG CERT_UID=1000
ARG CERT_GID=1000
ENV DOCKER_TLS_CERTDIR=

# Install docker compose plugin and bash
RUN apk add --no-cache docker-cli-compose bash

WORKDIR /app

# Copy entrypoint script
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Copy the pre-baked images tarball
# This file is expected to be generated by build.sh and placed in the context
COPY images.tar /images.tar

# Copy project configuration files
COPY docker-compose.docker.yml /app/
COPY config /app/config
COPY .env /app/.env
COPY bundle /app/bundle

# Copy certificates
RUN mkdir -p /root/${BRAND_HOME}/certs
COPY --chown=${CERT_UID}:${CERT_GID} certs /root/${BRAND_HOME}/certs

ENTRYPOINT ["entrypoint.sh"]

# Start services using docker compose
CMD ["docker", "compose", "-f", "docker-compose.docker.yml", "up", "--no-build"]
