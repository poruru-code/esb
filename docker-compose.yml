# Lambda functions start dynamically (on-demand start, idle stop).

services:
  # ============================================
  # Permission Helper (for RustFS)
  # ============================================
  permission-helper:
    image: alpine
    container_name: esb-permission-helper
    volumes:
      - rustfs_data:/data/rustfs
    command: >
      sh -c "
        chown -R 10001:10001 /data/rustfs 2>/dev/null || true && echo 'RustFS permissions fixed'
      "
    restart: "no"

  # ============================================
  # RustFS (S3 Compatible Storage)
  # ============================================
  s3-storage:
    image: rustfs/rustfs:latest
    container_name: esb-storage
    depends_on:
      permission-helper:
        condition: service_completed_successfully
    ports:
      - "${RUSTFS_API_PORT:-9000}:9000" # S3 API
      - "${RUSTFS_CONSOLE_PORT:-9001}:9001" # Console
    volumes:
      - rustfs_data:/data/rustfs
      - ./config/lifecycle.yml:/app/config/lifecycle.yml:ro
    environment:
      - RUSTFS_VOLUMES=/data/rustfs
      - RUSTFS_ADDRESS=0.0.0.0:9000
      - RUSTFS_ACCESS_KEY=${RUSTFS_ACCESS_KEY?RUSTFS_ACCESS_KEY is required}
      - RUSTFS_SECRET_KEY=${RUSTFS_SECRET_KEY?RUSTFS_SECRET_KEY is required}
      - RUSTFS_CONSOLE_ENABLE=true
      - RUSTFS_CONSOLE_ADDRESS=0.0.0.0:9001
      - RUSTFS_DEDUPLICATION=${RUSTFS_DEDUPLICATION:-true}
      - RUSTFS_COMPRESSION=${RUSTFS_COMPRESSION:-auto}
      - RUSTFS_LIFECYCLE_POLICY_PATH=/app/config/lifecycle.yml
    healthcheck:
      test: [ "CMD", "sh", "-c", "curl -f --noproxy '*' http://127.0.0.1:9000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - external_network # Public exposure
      - internal_network # Lambda-to-Lambda communication

  # ============================================
  # ScyllaDB (DynamoDB Compatible DB)
  # ============================================
  database:
    image: scylladb/scylla:latest
    container_name: esb-database
    ports:
      - "${SCYLLADB_PORT:-8001}:8000" # Alternator API (Host 8001 -> Container 8000)
    volumes:
      - scylladb_data:/var/lib/scylla
    command: --smp 1 --memory ${SCYLLADB_MEMORY:-1}G --developer-mode 1 --alternator-port 8000 --alternator-address 0.0.0.0 --alternator-write-isolation always_use_lwt
    healthcheck:
      test: [ "CMD-SHELL", "cqlsh -e 'DESCRIBE KEYSPACES' || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 180s
    restart: unless-stopped
    networks:
      - external_network # Public exposure
      - internal_network # Lambda-to-Lambda communication

  # Fluent Bit is deprecated. Logs are sent directly from each service to VictoriaLogs.

  # ============================================
  # Container Registry (Local)
  # ============================================
  registry:
    image: registry:2
    container_name: esb-registry
    ports:
      - "${REGISTRY_PORT:-5010}:5010" # Registry API (pushes from host)
    volumes:
      - registry_data:/var/lib/registry
      - ${ESB_CERT_DIR:-~/.esb/certs}/server.crt:/certs/server.crt:ro
      - ${ESB_CERT_DIR:-~/.esb/certs}/server.key:/certs/server.key:ro
    environment:
      REGISTRY_HTTP_ADDR: 0.0.0.0:5010
      REGISTRY_HTTP_TLS_CERTIFICATE: /certs/server.crt
      REGISTRY_HTTP_TLS_KEY: /certs/server.key
    healthcheck:
      test: ["CMD", "wget", "-q", "-Y", "off", "--spider", "--no-check-certificate", "https://127.0.0.1:5010/v2/"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped
    networks:
      - external_network # Host access
      - internal_network # For agent (used during Step 1 containerd migration)

  # ============================================
  # VictoriaLogs
  # ============================================
  victorialogs:
    image: victoriametrics/victoria-logs:latest
    container_name: victorialogs
    ports:
      - "${VICTORIALOGS_PORT:-9428}:9428" # VictoriaLogs UI/API
    volumes:
      - victorialogs_data:/victoria-logs-data
    command:
      - "-storageDataPath=/victoria-logs-data"
      - "-retentionPeriod=7d"
    healthcheck:
      test: [ "CMD", "wget", "-q", "-Y", "off", "--spider", "http://127.0.0.1:9428/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - external_network # Public exposure
      - internal_network # Lambda-to-Lambda communication

  # ============================================
  # API Gateway (Facade)
  # ============================================
  gateway:
    image: gateway-api:latest
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    container_name: esb-gateway
    # Host Network: Gateway listens on localhost:443
    network_mode: host
    volumes:
      - ${ESB_CERT_DIR:-~/.esb/certs}/server.crt:/app/config/ssl/server.crt:ro
      - ${ESB_CERT_DIR:-~/.esb/certs}/server.key:/app/config/ssl/server.key:ro
      - ${GATEWAY_FUNCTIONS_YML:-./config/functions.yml}:/app/config/functions.yml:ro
      - ${GATEWAY_ROUTING_YML:-./config/routing.yml}:/app/config/routing.yml:ro
    environment:
      - UVICORN_BIND_ADDR=0.0.0.0:443
      - ENABLE_SSL=true
      - SSL_CERT_PATH=/app/config/ssl/server.crt
      - SSL_KEY_PATH=/app/config/ssl/server.key
      - JWT_SECRET_KEY=${JWT_SECRET_KEY?JWT_SECRET_KEY is required}
      - X_API_KEY=${X_API_KEY?X_API_KEY is required}
      - AUTH_USER=${AUTH_USER?AUTH_USER is required}
      - AUTH_PASS=${AUTH_PASS?AUTH_PASS is required}
      - CONTAINERS_NETWORK=${LAMBDA_NETWORK?LAMBDA_NETWORK is required}
      - GATEWAY_INTERNAL_URL=https://10.88.0.1:443  # Lambda containers -> Host Network Gateway (CNI bridge)
      - USE_GRPC_AGENT=true
      - AGENT_GRPC_ADDRESS=localhost:50051  # Host Network
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RUSTFS_ACCESS_KEY=${RUSTFS_ACCESS_KEY?RUSTFS_ACCESS_KEY is required}
      - RUSTFS_SECRET_KEY=${RUSTFS_SECRET_KEY?RUSTFS_SECRET_KEY is required}
      - LAMBDA_INVOKE_TIMEOUT=${LAMBDA_INVOKE_TIMEOUT:-30.0}
      - CIRCUIT_BREAKER_THRESHOLD=${CIRCUIT_BREAKER_THRESHOLD:-5}
      - CIRCUIT_BREAKER_RECOVERY_TIMEOUT=${CIRCUIT_BREAKER_RECOVERY_TIMEOUT:-30.0}
      - PYTHONUNBUFFERED=1
      # VictoriaLogs direct-send configuration (Lambda via grpc_provision.py)
      - VICTORIALOGS_URL=http://10.88.0.1:9428  # Host Network (CNI bridge)
      # Auto-Scaling Configuration
      - DEFAULT_MAX_CAPACITY=${DEFAULT_MAX_CAPACITY:-1}
      - DEFAULT_MIN_CAPACITY=${DEFAULT_MIN_CAPACITY:-0}
      - POOL_ACQUIRE_TIMEOUT=${POOL_ACQUIRE_TIMEOUT:-5.0}
      - HEARTBEAT_INTERVAL=${HEARTBEAT_INTERVAL:-30}
      - GATEWAY_IDLE_TIMEOUT_SECONDS=${GATEWAY_IDLE_TIMEOUT_SECONDS:-300}
      - ENABLE_CONTAINER_PAUSE=${ENABLE_CONTAINER_PAUSE:-false}
      - PAUSE_IDLE_SECONDS=${PAUSE_IDLE_SECONDS:-30}
    depends_on:
      agent:
        condition: service_started
      database:
        condition: service_healthy
      s3-storage:
        condition: service_healthy
      victorialogs:
        condition: service_healthy
    restart: unless-stopped

  # ============================================
  # Go Agent (Replacement for Orchestrator)
  # ============================================
  agent:
    image: esb-agent:latest
    build:
      context: services/agent
      dockerfile: Dockerfile
    container_name: esb-agent
    privileged: true
    pid: host
    # Host Network: Agent listens on localhost:50051
    network_mode: host
    volumes:
      - /run/containerd:/run/containerd  # Required for socket, fifo, and shim access
      - /var/lib/containerd:/var/lib/containerd  # Required for snapshot access
      - ./services/agent/config/cni:/etc/cni/net.d:ro
      - esb_cni_data:/var/lib/cni
      - ${ESB_CERT_DIR:-~/.esb/certs}/rootCA.crt:/usr/local/share/ca-certificates/esb-rootCA.crt:ro
    environment:
      - AGENT_RUNTIME=containerd  # Use containerd with host network strategy
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PORT=50051
      - CONTAINER_REGISTRY=localhost:5010  # Host Network access
    depends_on:
      registry:
        condition: service_healthy
    command: >
      sh -c "update-ca-certificates && /app/agent"
    restart: unless-stopped

volumes:
  scylladb_data:
  rustfs_data:
  victorialogs_data:
  registry_data:
  esb_cni_data:


networks:
  # Public network (exposed ports).
  external_network:
    name: ${EXTERNAL_NETWORK?EXTERNAL_NETWORK is required}
    driver: bridge
  # Lambda-to-Lambda network only (no external access).
  internal_network:
    name: ${LAMBDA_NETWORK?LAMBDA_NETWORK is required}
    driver: bridge
    internal: true
