## 概要
- ブランディング生成ツールは `esb-branding-tool` リポジトリへ分離済みです。
- 生成はツール repo 側で `uv run python tools/branding/generate.py --root <target> --brand <name>` を実行します。
- ESB 本体は `brand: esb` を維持し、生成物のみを追跡します（`.branding.env` は追跡しない）。

## ブランド切り替えワークフロー
1. ツール repo から `uv run python tools/branding/generate.py --root <target> --brand <name>` を実行します。
2. ツールが検出したブランド名を `config/branding.yaml` に書き戻し、`BRANDING_*` 環境変数を `.branding.env` に追記します。
3. 自動生成ファイル群（`docker-compose*.yml`・`services/runtime-node/entrypoint*.sh` など）が更新されるので内容を確認し、差分が整合していることを確認後コミット。
4. 必要なら `uv run python tools/branding/generate.py --root <target> --check --brand <name>` で差分検証。Lint チェックや CI への影響を避けたいときに利用します。中身だけを整えておきたい場合は `--no-header` を使ってコメント部分を省略できます。

## ヘッダーの共通ルール
| ファイル形式 | コメント形式 | 内容（例） |
|---------------|--------------|------------|
| シェル/YAML/TOML/Go/Python | `#`（または Go の `//`） | `Where`, `What`, `Why`, `Source` を記載 |
| JSON（CNI など） | `_comment` フィールド | `"Auto-generated by branding generator. Do not edit directly. Source: ..."` |
- すべてのテンプレート（`tools/branding/templates/` 以下）にはこのヘッダーを含め、生成後のファイルも同じ形式になるようにする。
- 生成時にヘッダーを変更する場合はテンプレートを更新する。ヘッダーに含める `Source` には元テンプレートの相対パスを明記。
  - テンプレートはツール repo 側（`esb-branding-tool/tools/branding/templates/`）に配置する。

## CNI 設定の管理
- `services/agent/config/cni` ディレクトリには `10-<slug>.conflist` が 1 つだけ残る。ブランド名を変えたら生成ツールが旧ファイルを自動削除し、新しい `<slug>` 名のファイルだけを残す。
- `10-cni.conflist.tmpl` には `_comment` フィールド付きヘッダーを追加し、コメントに生成元テンプレートを記載。

## ステージングキャッシュ
- 生成された `functions.yml` / `routing.yml` のステージングはリポジトリ外に置く。
- パスは `XDG_CACHE_HOME/<slug>/staging` を優先し、未設定時は `~/.<slug>/.cache/staging` を使う。
- ステージングのディレクトリ名は `project + env` のハッシュを含める。
- `ESB_CONFIG_DIR` はステージング済みの `config/` を指し、Docker ビルドの追加コンテキストとして利用する。
- 追加コンテキストを使うため、Docker BuildKit を有効化する（`DOCKER_BUILDKIT=1`）。
- 関数イメージには `com.<slug>.image_fingerprint` ラベルを付け、`project + env` と出力内容、lambda base の ID を基に更新判定する（`--no-cache` で無効化）。

## CA とビルドフロー
- `mise run setup:certs` により `uv run python tools/cert-gen/generate.py` が呼ばれ、`CAROOT` は `.mise.toml` の設定に依存せず、現ブランドの `~/.<slug>/certs` を使う。
- Docker ビルド（`services/common/Dockerfile.*`）には `ROOT_CA_FINGERPRINT` を渡し、ツール repo で再生成した `docker-compose*.yml` やエージェント・ランタイムのソースを使用する。

## ツール repo での実行例
- 例: `uv run python tools/branding/generate.py --root /tmp/downstream --brand padma`
- ヘッダーだけを出力から外したいときは `--no-header` を組み合わせる。
- `--check` は読み取り専用で、`config/branding.yaml` と `--brand` が食い違う場合はエラーにする。

## テスト/確認
- 生成後は `uv run e2e/run_tests.py --reset --profile e2e-containerd` などで E2E を再実行し、CA, CNI, CLI 名称の整合性を確認。
- 事前に `uv run python tools/branding/generate.py --root <target> --check` でチェックし、差分を確認してから実際に書き出すとよい。
