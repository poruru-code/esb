# Auto-generated by branding generator. Do not edit directly.
# Source: tools/branding/templates/.mise.toml.tmpl
# Where: .mise.toml
# What: Local toolchain and task definitions.
# Why: Keep brand-sensitive ctl build output reproducible across repositories.

# Toolchain versions managed by mise.

[tools]
# Runtimes
python = "3.12"
go = "1.25.1"
uv = "0.8.13"
lefthook = "2.0.15"
step = "0.28.7"
buf = "1.65.0"

# Go tooling (installed via go install)
"go:github.com/golangci/golangci-lint/cmd/golangci-lint" = "latest"
"go:mvdan.cc/gofumpt" = "latest"
"go:golang.org/x/tools/cmd/goimports" = "latest"

[env]
_.path = ["~/.local/bin"]

[tasks.setup]
description = "Install dependencies and enable git hooks"
run = [
  "uv sync --all-extras --native-tls",
  "lefthook install",
  "mise run build-ctl",
  "mise run setup:buildx",
  "mise run setup:certs",
]

[tasks."setup:certs"]
description = "Generate development certificates using step-cli"
run = "uv run python tools/cert-gen/generate.py"

[tasks."rotate:certs:leaf"]
description = "Regenerate server/client certificate files only (restart required)"
run = [
  "CERT_DIR=\"${CERT_DIR:-$(uv run python tools/cert-gen/generate.py --show-output-dir)}\"; rm -f \"$CERT_DIR/server.crt\" \"$CERT_DIR/server.key\" \"$CERT_DIR/client.crt\" \"$CERT_DIR/client.key\"",
  "mise run setup:certs",
]

[tasks."rotate:certs:leaf:docker"]
description = "Regenerate leaf certs and restart gateway/agent in docker mode"
run = [
  "mise run rotate:certs:leaf",
  "docker compose -f docker-compose.docker.yml restart agent gateway",
]

[tasks."rotate:certs:leaf:containerd"]
description = "Regenerate leaf certs and restart gateway/agent in containerd mode"
run = [
  "mise run rotate:certs:leaf",
  "docker compose -f docker-compose.containerd.yml restart agent gateway",
]

[tasks."rotate:certs:all:files"]
description = "Regenerate Root CA and leaf certificate files only (no image rebuild)"
run = "mise run setup:certs -- --force --no-trust-install"

[tasks."rotate:certs:all:docker"]
description = "Regenerate Root/leaf certs, then rebuild/redeploy docker mode services"
run = [
  "mise run rotate:certs:all:files",
  "CERT_DIR=\"${CERT_DIR:-$(uv run python tools/cert-gen/generate.py --show-output-dir)}\"; ROOT_CA_FINGERPRINT=$(md5sum \"$CERT_DIR/rootCA.crt\"); ROOT_CA_FINGERPRINT=${ROOT_CA_FINGERPRINT%% *}; ROOT_CA_FINGERPRINT=\"$ROOT_CA_FINGERPRINT\" docker compose -f docker-compose.docker.yml build os-base python-base gateway agent",
  "docker compose -f docker-compose.docker.yml up -d --force-recreate gateway agent",
]

[tasks."rotate:certs:all:containerd"]
description = "Regenerate Root/leaf certs, then rebuild/redeploy containerd mode services"
run = [
  "mise run rotate:certs:all:files",
  "CERT_DIR=\"${CERT_DIR:-$(uv run python tools/cert-gen/generate.py --show-output-dir)}\"; ROOT_CA_FINGERPRINT=$(md5sum \"$CERT_DIR/rootCA.crt\"); ROOT_CA_FINGERPRINT=${ROOT_CA_FINGERPRINT%% *}; ROOT_CA_FINGERPRINT=\"$ROOT_CA_FINGERPRINT\" docker compose -f docker-compose.containerd.yml build os-base python-base runtime-node agent gateway",
  "docker compose -f docker-compose.containerd.yml up -d --force-recreate runtime-node agent gateway",
]

[tasks."rotate:certs:all"]
description = "Guard task: choose rotate:certs:all:docker or rotate:certs:all:containerd"
run = "echo 'Use one of: mise run rotate:certs:all:docker or mise run rotate:certs:all:containerd' >&2; exit 1"

[tasks."setup:buildx"]
description = "Create buildx builder and buildkitd config"
run = "uv run python tools/buildkit/setup_buildx.py"

[tasks.gen-proto]
description = "Generate Agent/Gateway protobuf stubs from services/contracts/proto"
dir = "services/contracts"
run = [
  "buf generate . --template buf.gen.yaml",
  "uv run python scripts/fix_python_grpc_imports.py",
]

[tasks.build-ctl]
description = "Build esb-ctl to ~/.local/bin"
dir = "tools/artifactctl"
run = [
  "mkdir -p ~/.local/bin",
  "go build -o ~/.local/bin/esb-ctl ./cmd/artifactctl",
]
