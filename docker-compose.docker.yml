
services:
  # ------------------------------------------
  # 1. Agent Wiring (Standalone)
  # ------------------------------------------
  agent:
    env_file: config/defaults.env
    # Participate in Network Directly
    networks:
      - external_network
    environment:
      - AGENT_RUNTIME=docker
      - CONTAINERS_NETWORK=${NETWORK_EXTERNAL:-${PROJECT_NAME:-undefined}-external}
      - ENV
      - HTTP_PROXY
      - HTTPS_PROXY
      - NO_PROXY
      - http_proxy
      - https_proxy
      - no_proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # ------------------------------------------
  # 2. Gateway Wiring
  # ------------------------------------------
  gateway:
    env_file: config/defaults.env
    ports:
      - "${PORT_GATEWAY_HTTPS:-0}:8443"
    networks:
      - external_network
    depends_on:
      agent: { condition: service_started }
    environment:
      # Connect to Agent Directly
      - AGENT_GRPC_ADDRESS=agent:50051
      - GATEWAY_INTERNAL_URL=https://gateway:8443
      # Docker Mode Endpoints (Explicit DNS)
      - S3_ENDPOINT=http://s3-storage:9000
      - DYNAMODB_ENDPOINT=http://database:8000
      - GATEWAY_VICTORIALOGS_URL=http://victorialogs:9428
      - IMAGE_TAG=${IMAGE_TAG:-}
      - FUNCTION_IMAGE_PREFIX=${FUNCTION_IMAGE_PREFIX:-}
      # ESB_DATA_PLANE_HOST is ignored in Docker mode if endpoints are set
      - HTTP_PROXY
      - HTTPS_PROXY
      - NO_PROXY
      - http_proxy
      - https_proxy
      - no_proxy
