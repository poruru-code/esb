# syntax=docker/dockerfile:1.7
# Auto-generated by SAM Template Generator
# DO NOT EDIT MANUALLY - Regenerate with: esb build
# Source: template.yaml
# FunctionName: {{ .Name }}
FROM {{ .BaseImage }}

# ESB Runtime
{{- if not .ImageWrapper }}
ENV LAMBDA_ORIGINAL_HANDLER="{{ .OriginalHandler }}"
COPY {{ .JavaWrapperSource }} /var/task/lib/lambda-java-wrapper.jar
{{- end }}
{{- if .UseJavaAgent }}
COPY {{ .JavaAgentSource }} /var/task/lib/lambda-java-agent.jar
ENV JAVA_AGENT_PRESENT=1
ENV JAVA_TOOL_OPTIONS="-javaagent:/var/task/lib/lambda-java-agent.jar ${JAVA_TOOL_OPTIONS}"
{{- end }}

{{- range .Layers }}
# Layer: {{ .Name }}
COPY {{ .ContentURI }}/ /opt/
{{- end }}

{{- if not .ImageWrapper }}
# Function code
COPY {{ .CodeURI }} ${LAMBDA_TASK_ROOT}/

# Keep compatibility for apps that read ./configuration/* as real files.
# When CodeUri is a single jar, stage.go places it under /var/task/lib/*.jar.
# Extract only configuration/ from app jars (skip ESB wrapper/agent jars).
RUN set -eu; \
    cd ${LAMBDA_TASK_ROOT}; \
    [ -d configuration ] && exit 0; \
    for app_jar in lib/*.jar; do \
      [ -f "${app_jar}" ] || continue; \
      case "$(basename "${app_jar}")" in \
        lambda-java-wrapper.jar|lambda-java-agent.jar) continue ;; \
      esac; \
      if jar tf "${app_jar}" | grep -q '^configuration/'; then \
        jar xf "${app_jar}" configuration; \
        break; \
      fi; \
    done

# Handler
CMD [ "{{ .Handler }}" ]
{{- end }}
