# Auto-generated by branding generator. Do not edit directly.
# Source: tools/branding/templates/docker-compose.fc.yml.tmpl

include:
  - compose/base.yml
  - compose/registry.yml

services:
  # ------------------------------------------
  # 1. Gateway Wiring (WireGuard for FC Mode)
  # ------------------------------------------
# Removed runtime-node, coredns, agent (moved to fc-node.yml)

  # ------------------------------------------
  # 3. Gateway Wiring (WireGuard for FC Mode)
  # ------------------------------------------
  gateway:
    user: "0:0"
    build:
      context: .
      dockerfile: services/gateway/Dockerfile.firecracker
      additional_contexts:
        config: ${CONFIG_DIR:-services/gateway/config}
      args:
        SERVICE_UID: ${RUN_UID:-1000}
        SERVICE_GID: ${RUN_GID:-1000}
    ports:
      - "${PORT_GATEWAY_HTTPS:-0}:8443"
    networks:
      - external_network
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    volumes:
      - ${WG_GATEWAY_CONF:-~/.esb/wireguard/gateway/wg0.conf}:/app/config/wireguard/wg0.conf:ro
      - ./config/haproxy.gateway.cfg:/app/config/haproxy.gateway.cfg:ro
    environment:
      # Connect to Runtime Node (Host of Agent)
      - AGENT_GRPC_ADDRESS=runtime-node:50051
      # mTLS (disabled for Firecracker mode)
      # - AGENT_GRPC_TLS_ENABLED=1
      # - AGENT_GRPC_TLS_CA_CERT_PATH=/app/config/ssl/rootCA.crt
      # - AGENT_GRPC_TLS_CERT_PATH=/app/config/ssl/client.crt
      # - AGENT_GRPC_TLS_KEY_PATH=/app/config/ssl/client.key
      # WireGuard endpoint for Lambda -> Gateway
      - GATEWAY_INTERNAL_URL=https://10.99.0.1:8443
      - IMAGE_TAG=${IMAGE_TAG:-}
      - FUNCTION_IMAGE_PREFIX=registry:5010/
      - GATEWAY_WORKER_ROUTE_VIA_HOST=${GATEWAY_WORKER_ROUTE_VIA_HOST:-}
      - GATEWAY_WORKER_ROUTE_VIA=${GATEWAY_WORKER_ROUTE_VIA:-}
      - GATEWAY_WORKER_ROUTE_CIDR=${GATEWAY_WORKER_ROUTE_CIDR:-10.88.0.0/16}

volumes:
  runtime_containerd_run:
  runtime_containerd_lib:
  esb_cni_data:
  esb_cni_conf:
