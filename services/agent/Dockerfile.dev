FROM golang:1.25.1-bookworm@sha256:c423747fbd96fd8f0b1102d947f51f9b266060217478e5f9bf86f145969562ee

WORKDIR /app

# Install Air for hot reload
RUN go install github.com/air-verse/air@latest

# Install CNI plugins, iptables, and ctr (containerd CLI)
RUN apt-get update && apt-get install -y curl iptables containerd && \
    CNI_PLUGINS_VERSION="v1.3.0" && \
    ARCH=$(go env GOARCH) && \
    curl -L -o cni-plugins.tgz "https://github.com/containernetworking/plugins/releases/download/${CNI_PLUGINS_VERSION}/cni-plugins-linux-${ARCH}-${CNI_PLUGINS_VERSION}.tgz" && \
    mkdir -p /opt/cni/bin && \
    tar -C /opt/cni/bin -xzf cni-plugins.tgz && \
    rm cni-plugins.tgz

# Copy module files for caching
COPY go.mod go.sum ./
RUN go mod download

# Note: We don't COPY . . here because we use volume mounts in docker-compose.dev.yml
# but for initial setup or if volumes are not used, it doesn't hurt.

CMD ["air", "-c", ".air.toml"]
