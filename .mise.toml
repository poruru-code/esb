# Toolchain versions managed by mise.
 
[tools]
# Runtimes
python = "3.12"
go = "1.25.1"
uv = "0.8.13"
lefthook = "2.0.15"
step = "0.28.7"
 
# Go tooling (installed via go install)
"go:github.com/golangci/golangci-lint/cmd/golangci-lint" = "latest"
"go:mvdan.cc/gofumpt" = "latest"
"go:golang.org/x/tools/cmd/goimports" = "latest"
"go:github.com/air-verse/air" = "latest"

[env]
_.path = ["~/.local/bin"]
# CLI_CMD is read from config/defaults.env at runtime
 
[tasks.setup]
description = "Install dependencies and enable git hooks"
run = [
  "uv sync --all-extras",
  "lefthook install",
  "mise run build-cli",
  "mise run setup:certs",
]

[tasks."setup:certs"]
description = "Generate development certificates using step-cli"
run = "uv run python tools/cert-gen/generate.py"

[tasks."setup:buildx"]
description = "Initialize docker buildx builder (docker-container driver, optional)"
run = "bash -lc 'set -euo pipefail; source config/defaults.env; builder=\"${CLI_CMD:-esb}-buildx\"; if ! docker buildx inspect \"$builder\" >/dev/null 2>&1; then docker buildx create --name \"$builder\" --driver docker-container --driver-opt network=host --use; else driver=$(docker buildx inspect \"$builder\" | awk -F\": \" \"/Driver:/ {print $2; exit}\"); if [ \"$driver\" != \"docker-container\" ]; then echo \"Buildx builder ${builder} uses driver ${driver}. Remove it or choose a new name.\" >&2; exit 1; fi; docker buildx use \"$builder\"; fi; docker buildx inspect --bootstrap \"$builder\" >/dev/null; container=\"buildx_buildkit_${builder}0\"; net=$(docker inspect -f \"{{.HostConfig.NetworkMode}}\" \"$container\" 2>/dev/null || true); if [ \"${net}\" != \"host\" ]; then echo \"Buildx builder ${builder} uses network mode ${net:-unknown}. Remove it and re-run mise run setup:buildx.\" >&2; exit 1; fi'"

[tasks.build-cli]
description = "Build CLI to ~/.local/bin"
dir = "cli"
run = [
  "bash -lc 'source ../config/defaults.env && go build -o ~/.local/bin/${CLI_CMD} ./cmd/esb'",
  "bash -lc 'source ../config/defaults.env && mkdir -p ~/.local/share/bash-completion/completions && ~/.local/bin/${CLI_CMD} completion bash > ~/.local/share/bash-completion/completions/${CLI_CMD}'",
]

[tasks.dev-cli]
description = "Watch and rebuild CLI on changes"
dir = "cli"
run = "air"
