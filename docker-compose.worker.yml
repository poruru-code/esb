# Worker services (Agent for container management).
services:
  agent:
    env_file: config/defaults.env
    image: ${IMAGE_PREFIX:-undefined}-agent:${IMAGE_TAG:-latest}
    build:
      context: services/agent
      dockerfile: Dockerfile
      additional_contexts:
        meta: meta
      args:
        IMAGE_PREFIX: ${IMAGE_PREFIX:-undefined}
        OS_BASE_IMAGE: esb-os-base:latest
    container_name: ${PROJECT_NAME:-undefined}-agent
    cap_add: [NET_ADMIN, SYS_ADMIN]
    environment:
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - PORT=50051
      - CONTAINER_REGISTRY=${CONTAINER_REGISTRY:-}
      - CNI_SUBNET=${CNI_SUBNET:-}
      # mTLS (disabled; set in adapters as needed)
      # - AGENT_GRPC_TLS_ENABLED=1
      # - AGENT_GRPC_CERT_PATH=/app/config/ssl/server.crt
      # - AGENT_GRPC_KEY_PATH=/app/config/ssl/server.key
      # - AGENT_GRPC_CA_CERT_PATH=/app/config/ssl/rootCA.crt
      # Default: Overridden by Adapter
      - AGENT_RUNTIME=${AGENT_RUNTIME:-containerd}
      - CONTAINERS_NETWORK=${NETWORK_EXTERNAL:-${PROJECT_NAME:-undefined}-external}
      - HTTP_PROXY
      - HTTPS_PROXY
      - NO_PROXY
      - http_proxy
      - https_proxy
      - no_proxy
    volumes:
      - ${CERT_DIR:-~/.esb/certs}:/app/config/ssl:ro
    command: ["/app/agent"]
    restart: unless-stopped
