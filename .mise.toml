# Toolchain versions managed by mise.
 
[tools]
# Runtimes
python = "3.12"
go = "1.25.1"
uv = "0.8.13"
lefthook = "2.0.15"
step = "0.28.7"
buf = "1.65.0"
 
# Go tooling (installed via go install)
"go:github.com/golangci/golangci-lint/cmd/golangci-lint" = "latest"
"go:mvdan.cc/gofumpt" = "latest"
"go:golang.org/x/tools/cmd/goimports" = "latest"

[env]
_.path = ["~/.local/bin"]
 
[tasks.setup]
description = "Install dependencies and enable git hooks"
run = [
  "uv sync --all-extras",
  "lefthook install",
  "mise run check-esb",
  "mise run build-artifactctl",
  "mise run setup:certs",
  "mise run setup:buildx",
]

[tasks."setup:certs"]
description = "Generate development certificates using step-cli"
run = "uv run python tools/cert-gen/generate.py"

[tasks."setup:buildx"]
description = "Create buildx builder and buildkitd config"
run = "uv run python tools/buildkit/setup_buildx.py"

[tasks.gen-proto]
description = "Generate Agent/Gateway protobuf stubs from services/contracts/proto"
dir = "services/contracts"
run = [
  "buf generate . --template buf.gen.yaml",
  "uv run python scripts/fix_python_grpc_imports.py",
]

[tasks.check-esb]
description = "Ensure esb CLI is installed (from esb-cli repo)"
run = "command -v esb >/dev/null 2>&1 || { echo 'esb not found. Install from https://github.com/poruru-code/esb-cli'; exit 1; }"

[tasks.build-artifactctl]
description = "Build artifactctl to ~/.local/bin"
dir = "tools/artifactctl"
run = [
  "mkdir -p ~/.local/bin",
  "go build -o ~/.local/bin/artifactctl ./cmd/artifactctl",
]
