
include:
  - compose/base.yml
  - compose/worker.yml
  - compose/registry.yml

services:
  # ------------------------------------------
  # 1. Runtime Node (Containerd Host Container)
  # ------------------------------------------
  runtime-node:
    env_file: config/defaults.env
    build:
      context: services/runtime-node
      dockerfile: Dockerfile
      args:
        OS_BASE_IMAGE: esb-os-base:latest
    container_name: ${PROJECT_NAME:-undefined}-runtime-node
    entrypoint: /entrypoint.containerd.sh
    privileged: true
    ports:
      - "${PORT_AGENT_GRPC:-0}:50051"
      - "${PORT_GATEWAY_HTTPS:-0}:8443"  # Gateway port (shared network)
      - "${PORT_AGENT_METRICS:-0}:9091" # Agent Metrics
    networks:
      - external_network
    environment:
      - CNI_GW_IP=${DATA_PLANE_HOST:-10.88.0.1}
      - VHOST_VSOCK_REQUIRED=0
    volumes:
      # Share containerd socket and state with Agent
      - runtime_containerd_run:/run/containerd
      - runtime_containerd_lib:/var/lib/containerd
      - ${CERT_DIR:-~/.esb/certs}:/app/config/ssl:ro
    healthcheck:
      test: ["CMD", "ctr", "-a", "/run/containerd/containerd.sock", "version"]
      interval: 5s
      retries: 10
    restart: unless-stopped

  # ------------------------------------------
  # 2. coredns (Local DNS for Lambda VMs)
  # ------------------------------------------
  coredns:
    env_file: config/defaults.env
    image: coredns/coredns:1.11.1
    container_name: ${PROJECT_NAME:-undefined}-coredns
    network_mode: "service:runtime-node"
    volumes:
      - ./config/Corefile:/Corefile:ro
    command: -conf /Corefile
    depends_on:
      runtime-node: { condition: service_started }
    restart: unless-stopped

  # ------------------------------------------
  # 3. Agent Wiring (Shares network with runtime-node)
  # ------------------------------------------
  agent:
    env_file: config/defaults.env
    network_mode: "service:runtime-node"
    pid: "service:runtime-node"
    depends_on:
      runtime-node: { condition: service_healthy }
      registry: { condition: service_healthy }
    volumes:
      - runtime_containerd_run:/run/containerd
      - runtime_containerd_lib:/var/lib/containerd
      - esb_cni_data:/var/lib/cni
      - esb_cni_conf:/etc/cni/net.d
      - ${CERT_DIR:-~/.esb/certs}:/app/config/ssl:ro
    environment:
      - AGENT_RUNTIME=containerd
      - AGENT_GRPC_TLS_ENABLED=1
      - AGENT_GRPC_CERT_PATH=/app/config/ssl/server.crt
      - AGENT_GRPC_KEY_PATH=/app/config/ssl/server.key
      - AGENT_GRPC_CA_CERT_PATH=/app/config/ssl/rootCA.crt
      # No Firecracker shim - use default containerd runtime
      - CONTAINER_REGISTRY=registry:5010
      - CONTAINERS_NETWORK=${NETWORK_EXTERNAL:-${PROJECT_NAME:-undefined}-external}
      - ENV

  registry:
    env_file: config/defaults.env
    healthcheck:
      test: ["CMD-SHELL", "wget -q -Y off --no-check-certificate --spider https://localhost:5010/v2/ || exit 1"]

  # ------------------------------------------
  # 4. Gateway Wiring (Shares network namespace with runtime-node)
  # ------------------------------------------
  gateway:
    env_file: config/defaults.env
    network_mode: "service:runtime-node"
    depends_on:
      agent: { condition: service_started }
    environment:
      # Connect to Agent (same network namespace)
      - AGENT_GRPC_ADDRESS=localhost:50051
      - AGENT_GRPC_TLS_ENABLED=1
      - AGENT_GRPC_TLS_CA_CERT_PATH=/app/config/ssl/rootCA.crt
      - AGENT_GRPC_TLS_CERT_PATH=/app/config/ssl/client.crt
      - AGENT_GRPC_TLS_KEY_PATH=/app/config/ssl/client.key
      # Gateway URL accessible from CNI subnet
      - GATEWAY_INTERNAL_URL=https://${DATA_PLANE_HOST:-10.88.0.1}:8443
      # Data Plane Host (for constructing S3/DB endpoints in code)
      - DATA_PLANE_HOST=${DATA_PLANE_HOST:-10.88.0.1}
      - IMAGE_TAG=${IMAGE_TAG:-}
      - FUNCTION_IMAGE_PREFIX=registry:5010/
      # Service endpoints resolved via CoreDNS in the CNI subnet
      - DYNAMODB_ENDPOINT=http://database:8000
      - S3_ENDPOINT=http://s3-storage:9000
      - GATEWAY_VICTORIALOGS_URL=http://victorialogs:9428
    volumes:
      - ${CERT_DIR:-~/.esb/certs}:/app/config/ssl:ro

volumes:
  runtime_containerd_run:
  runtime_containerd_lib:
  esb_cni_data:
  esb_cni_conf:
