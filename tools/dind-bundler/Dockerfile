FROM docker:24-dind

# Install docker compose plugin and bash
RUN apk add --no-cache docker-cli-compose bash

WORKDIR /app

# Copy entrypoint script
COPY entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh

# Copy the pre-baked images tarball
# This file is expected to be generated by build.sh and placed in the context
COPY images.tar /images.tar

# Copy project configuration files
COPY docker-compose.docker.yml /app/
COPY config /app/config

# Copy certificates
RUN mkdir -p /root/.esb/certs
COPY certs /root/.esb/certs

ENTRYPOINT ["entrypoint.sh"]

# Start services using docker compose
CMD ["docker", "compose", "-f", "docker-compose.docker.yml", "up", "--no-build"]
