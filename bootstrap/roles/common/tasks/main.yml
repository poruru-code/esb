---
- name: Determine if proxy is set
  set_fact:
    use_proxy: "{{ proxy_http != '' or proxy_https != '' }}"

- name: Configure global environment variables for proxy in /etc/environment
  lineinfile:
    path: /etc/environment
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}=\"{{ item.value }}\""
    state: present
  loop:
    - { key: "http_proxy", value: "{{ proxy_http }}" }
    - { key: "https_proxy", value: "{{ proxy_https }}" }
    - { key: "HTTP_PROXY", value: "{{ proxy_http }}" }
    - { key: "HTTPS_PROXY", value: "{{ proxy_https }}" }
    - { key: "no_proxy", value: "{{ proxy_no }}" }
    - { key: "NO_PROXY", value: "{{ proxy_no }}" }
  when: use_proxy

- name: Configure apt proxy
  template:
    src: 01proxy.j2
    dest: /etc/apt/apt.conf.d/01proxy
    mode: '0644'
  when: use_proxy

- name: Configure sudoers to keep proxy environment variables
  lineinfile:
    path: /etc/sudoers
    regexp: '^Defaults\s+env_keep\s+\+=\s+"http_proxy https_proxy no_proxy"'
    line: 'Defaults env_keep += "http_proxy https_proxy no_proxy"'
    validate: 'visudo -cf %s'
  when: use_proxy

- name: Update apt cache
  apt:
    update_cache: yes
