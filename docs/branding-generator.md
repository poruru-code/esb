## 概要
- `tools/branding/generate.py` は `config/branding.yaml` のブランド名を起点として、テンプレートから CLI・Docker・ランタイムのファイルを再生成するツールです。
- ブランド名を切り替える場合は `mise run branding:generate -- --brand <name>` を実行し、差分確認だけなら `mise run branding:check -- --brand <name>` を使います。自動生成ヘッダーを抑止したい場合は `--no-header` を追加して中身だけを上書きできます。
- `mise setup` では再生成を行わず、依存インストールと CA 生成に集中させています。ブランド生成は手動で呼び出し、変更内容を確認してからコミットしてください。

## ブランド切り替えワークフロー
1. `config/branding.yaml` を編集し、新ブランド名を `brand: <name>` に変更するか、`--brand` オプションを使って `--brand padma` のように指定して `tools/branding/generate.py` を起動します。
2. ツールが検出したブランド名を `config/branding.yaml` に書き戻し、`BRANDING_*` 環境変数を `.branding.env` に追記。
3. 自動生成ファイル群（`docker-compose*.yml`・`services/runtime-node/entrypoint*.sh` など）が更新されるので内容を確認し、差分が整合していることを確認後コミット。
4. 必要なら `mise run branding:check -- --brand <name>` で差分検証。Lint チェックや CI への影響を避けたいときに利用する。中身だけを整えておきたい場合は `--no-header` を使ってコメント部分を省略できます。

## ヘッダーの共通ルール
| ファイル形式 | コメント形式 | 内容（例） |
|---------------|--------------|------------|
| シェル/YAML/TOML/Go/Python | `#`（または Go の `//`） | `Where`, `What`, `Why`, `Source` を記載 |
| JSON（CNI など） | `_comment` フィールド | `"Auto-generated by branding generator. Do not edit directly. Source: ..."` |
- すべてのテンプレート（`tools/branding/templates/` 以下）にはこのヘッダーを含め、生成後のファイルも同じ形式になるようにする。
- 生成時にヘッダーを変更する場合はテンプレートを更新する。ヘッダーに含める `Source` には元テンプレートの相対パスを明記。

## CNI 設定の管理
- `services/agent/config/cni` ディレクトリには `10-<slug>.conflist` が 1 つだけ残る。ブランド名を変えたら生成ツールが旧ファイルを自動削除し、新しい `<slug>` 名のファイルだけを残す。
- `10-cni.conflist.tmpl` には `_comment` フィールド付きヘッダーを追加し、コメントに生成元テンプレートを記載。

## CA とビルドフロー
- `mise run setup:certs` により `uv run python tools/cert-gen/generate.py` が呼ばれ、`CAROOT` は `.mise.toml` の設定に依存せず、現ブランドの `~/.<slug>/certs` を使う。
- Docker ビルド（`services/common/Dockerfile.*`）には `ROOT_CA_FINGERPRINT` を渡し、`branding:generate` を走らせることで `docker-compose*.yml` やエージェント・ランタイムのソースがブランド名を反映する。

## `mise branding:generate` タスク
- `mise branding:generate` は `uv run python tools/branding/generate.py` を実行し、続けて証明書生成と CLI ビルドを行う。必要に応じて `--brand`/`--no-header` を渡せる。
- 例: `mise run branding:generate -- --brand padma`
- ヘッダーだけを出力から外したいときは `--no-header` を組み合わせる（`mise run branding:generate -- --brand padma --no-header`）。
- 生成後に CLI 名をシェルで使う場合は `.branding.env` を `source .branding.env` してから実行してください。

## `mise branding:check` タスク
- `mise branding:check` は `uv run python tools/branding/generate.py --check` を実行し、差分がある場合に非ゼロで終了する。
- 例: `mise run branding:check -- --brand padma`
- ヘッダーを除外した状態で差分を見たい場合は `--no-header` を追加する（`mise run branding:check -- --brand padma --no-header`）。
- `--check` は読み取り専用で、`config/branding.yaml` と `--brand` が食い違う場合はエラーにする。

## テスト/確認
- 生成後は `uv run e2e/run_tests.py --reset --profile e2e-containerd` などで E2E を再実行し、CA, CNI, CLI 名称の整合性を確認。
- 事前に `uv run python tools/branding/generate.py --check` でチェックし、差分を確認してから実際に書き出すとよい。`mise run branding:check -- --brand <name>` でも同様。
